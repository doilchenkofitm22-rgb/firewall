# Простий програмний брандмауер на Python

Цей невеликий проєкт демонструє, як можна реалізувати програмний брандмауер на мові Python без використання зовнішніх бібліотек чи привілеїв ядра. Код одночасно виконує декілька задач: фільтрацію пакетів за заданими правилами, керування цими правилами в реальному часі та журнальне відстеження відхилених пакетів. Проєкт зберігає правила між запусками, а також надає невеликий HTTP API для віддаленого адміністрування.

## Як запустити

1.  Переконайтеся, що у вас встановлений Python 3.9 або новіший. У репозиторії немає залежностей, тому інсталяція пакетів не потрібна.
2.  Запустіть сервіс командою:
    ```bash
    python3 firewall.py
    ```
    У консолі з’явиться привітальне повідомлення та інтерактивне меню. Одночасно на адресі `http://127.0.0.1:8080` стартує HTTP‑сервер для віддаленого керування правилами.
3.  Для виходу з програми виберіть пункт 8 у меню або натисніть `Ctrl+C`.

## Структура правила

Кожне правило складається з кількох полів (усі крім `action` можуть бути порожніми):

| Поле      | Опис                              |
| -------- | ---------------------------------   |
| `src_ip`    | Вихідна IP‑адреса (рядок)          |
| `dest_ip`   | Призначення IP‑адреса              |
| `src_port`  | Порт джерела (ціле число)          |
| `dest_port` | Порт призначення                   |
| `protocol`  | Протокол (TCP або UDP)             |
| `action`    | Дія: `ALLOW` або `DENY`              |
| `enabled`   | Чи активне правило (`True`/`False`) |

Правила перевіряються по порядку. Перше активне правило, що підходить під пакет, визначає його долю. Якщо жодне правило не збігається, пакет дозволяється.

## Інтерактивне меню

Після запуску програма виводить меню:

1.  **Показати правила** — список поточних правил, їхній стан (увімкнено/вимкнено) та параметри.
2.  **Додати правило** — поетапно вводяться IP, порт і протокол. Порожнє значення означає «будь‑яке». Дія за замовчуванням — `DENY`.
3.  **Видалити правило** — вкажіть ідентифікатор з першої колонки списку.
4.  **Перемкнути правило (увімкнути/вимкнути)** — перемикає поле `enabled`; корисно для тимчасового відключення.
5.  **Виявити дублікати/конфлікти** — знаходить правила, які мають однакові умови. Дублікат (`ALLOW` з `ALLOW` або `DENY` з `DENY`) безпечний, але зайвий. Конфлікт виникає, коли два правила збігаються умовами, але одне дозволяє, інше забороняє.
6.  **Симулювати пакет** — введіть параметри пакета, щоб побачити, чи він буде дозволений чи заблокований. В разі блокування запис з’явиться у файлі `firewall.log`.
7.  **Пошук у журналах** — переглянути відхилені пакети за джерелом, призначенням або протоколом.
8.  **Вихід** — завершення роботи сервісу.

Додані правила автоматично зберігаються до файлу `rules.json`, тому при наступному запуску вони будуть завантажені.

## HTTP API

Окрім консольного інтерфейсу, брандмауер надає простий HTTP API. Це дає змогу змінювати налаштування з інших програм або з віддаленої машини (наприклад, через `curl`). Сервер прив’язаний до `127.0.0.1:8080` - при необхідності можна змінити порт у коді.

Доступні такі маршрути (усі використовують `GET`):

| Шлях          | Призначення                                                                        | Приклад                                                                                                |
| :------------ | :--------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------- |
| `/rules`      | Отримати поточну таблицю правил у форматі JSON                                      | `curl http://127.0.0.1:8080/rules`                                                                     |
| `/add`        | Додати правило. Параметри: `src_ip`, `dest_ip`, `src_port`, `dest_port`, `protocol`, `action` | `curl 'http://127.0.0.1:8080/add?dest_ip=10.0.0.5&dest_port=22&protocol=TCP&action=DENY'` |
| `/remove?id=X`| Видалити правило за ідентифікатором                                                | `curl http://127.0.0.1:8080/remove?id=2`                                                               |
| `/toggle?id=X`| Вмикнути/вимкнути правило                                                          | `curl http://127.0.0.1:8080/toggle?id=3`                                                               |
| `/conflicts`  | Отримати інформацію про дублікати та конфлікти                                     | `curl http://127.0.0.1:8080/conflicts`                                                                 |

Усі запити повертають відповідь у форматі JSON. При успіху додається нове правило з присвоєним ID. При помилці (наприклад, неправильний порт) повертається повідомлення про помилку.

**Зверніть увагу:** сервер слухає тільки `127.0.0.1`, щоб не бути доступним із зовнішньої мережі. Якщо потрібна віддалена робота, змініть аргумент `host` у функції `start_http_server()` на потрібну IP‑адресу, наприклад `'0.0.0.0'`.

## Журналювання

Усі відхилені пакети потрапляють до файлу `firewall.log` у форматі **JSON Lines** (кожен рядок - окремий запис). Запис містить час (UTC), ідентифікатор правила, причину та основні параметри пакета. 

У меню пункт 7 дозволяє виконати простий пошук у журналі за джерелом, призначенням або протоколом. Це корисно для швидкого аналізу, але для великого журналу варто використовувати зовнішні засоби.

## Імітація зміни мережевих налаштувань

Брандмауер демонструє можливість змінювати правила в реальному часі. Ви можете відкрити кілька терміналів або процесів: один, який генерує трафік (через пункт 6 меню або викликаючи `process_packet()` з іншого модуля), а інший, який додає або вимикає правила. Зміни набувають чинності негайно, оскільки таблиця правил спільна. Це імітує «віддалене вмикання/вимикання» — наприклад, за допомогою HTTP API можна переконатися, що з певного IP заборонено доступ на порт 22, а потім миттєво дозволити його.

## Виявлення конфліктів

Механізм виявлення конфліктів вважає конфліктом будь‑які два правила, які мають однакові умови, але різні дії. Наприклад, одне правило забороняє всі пакети з певної IP адреси, а друге дозволяє їх. Система відобразить пари ідентифікаторів таких правил у меню пункт 5 або через маршрут `/conflicts`. Вирішувати конфлікти адміністратор може вручну: змінити дію, видалити зайве правило або переупорядкувати список.

## Обмеження та ідеї для розвитку

*   Цей проєкт не перехоплює реальний мережевий трафік. Він лише імітує фільтрацію для демонстраційних цілей. Щоб інтегруватися з реальною мережею, потрібен доступ до API ядра (`iptables`, `nftables`) чи використання сторонніх бібліотек.
*   Проста система правил (тільки IP, порт, протокол). За потреби можна додати підтримку CIDR‑діапазонів, часових діапазонів, інтерфейсів тощо.
*   HTTP API обробляє лише `GET`‑запити для простоти. Для більшої безпеки та функціональності варто реалізувати `POST`/`DELETE` і автентифікацію.
*   Журнал не ротується. Якщо трафіку багато, файл може зрости. Можна передбачити архівацію або зберігання у базі даних.
*   Логіка конфліктів і дублікатів проста: порівнюються повні збіги всіх полів. Можна розширити її для перекриття за підмережами чи портовими діапазонами.


## Приклад повного використання

Нижче наведено покроковий приклад, який демонструє повний цикл роботи з програмою: завантаження, налаштування, створення правила, тестування та аналіз результатів. Цей сценарій можна відтворити у будь‑якій системі, де встановлено Python 3.

1.  **Завантаження проєкту.**
   У кореневій директорії повинні знаходитися `firewall.py` та `README.md`.

2.  **Запуск сервісу.**
    Відкрийте термінал та перейдіть у директорію проєкту, наприклад:
    ```bash
    cd ~/Downloads/simple-firewall
    python3 firewall.py
    ```
    На екрані з’явиться меню. В іншому терміналі можна скористатися HTTP API, але в цьому прикладі будемо використовувати інтерактивний режим.

3.  **Створення правила.**
    Припустимо, ви хочете заблокувати доступ на порт 22 (SSH) до сервера `10.0.0.5` з будь‑яких IP. У меню введіть `2`, щоб додати правило, і відповідайте на запитання:
    *   `Source IP:` залиште порожнім і натисніть Enter.
    *   `Destination IP:` введіть `10.0.0.5`.
    *   `Source port:` залиште порожнім.
    *   `Destination port:` введіть `22`.
    *   `Protocol:` введіть `TCP`.
    *   `Action:` введіть `DENY`.
    Програма повідомить ідентифікатор нового правила (наприклад, `ID 1`).

4.  **Перегляд таблиці правил.**
    Виберіть пункт `1` (Show rules). Ви побачите правило:
    ```
    ID 1: src_ip=*, dest_ip=10.0.0.5, src_port=*, dest_port=22, protocol=TCP, action=DENY, ENABLED
    ```

5.  **Імітація пакета.**
    Тепер перевіримо, що брандмауер блокує відповідні пакети. Виберіть пункт `6` (Simulate packet) і введіть такі дані:
    *   `Source IP:` 192.168.1.100
    *   `Destination IP:` 10.0.0.5
    *   `Source port:` 55555
    *   `Destination port:` 22
    *   `Protocol:` TCP
    Відповідь буде `Packet result: DENY`. Програма створить запис у файлі `firewall.log`, оскільки пакет заблоковано.

6.  **Перегляд журналу.**
    Щоб переконатися, що подія збережена, виберіть пункт `7` (Search logs) і введіть:
    *   `Source IP:` залиште порожнім (натисніть Enter).
    *   `Destination IP:` введіть `10.0.0.5`.
    *   `Protocol:` введіть `TCP`.
    Програма виведе одну або кілька рядків із позначкою часу, правилом `1` і даними пакета — це підтверджує, що журналування працює.

7.  **Зміна правила.**
    Припустимо, ви тимчасово хочете дозволити SSH. Виберіть пункт `4` (Toggle rule) і введіть ID правила (наприклад, `1`). Статус зміниться на `DISABLED`. Повторіть крок 5: у цьому випадку пакет буде дозволено (`Packet result: ALLOW`), а запис у журналі не з’явиться. Щоб знову заблокувати доступ, можна повернутися до пункту `4` та ввімкнути правило.

8.  **Завершення роботи.**
    Виберіть пункт `8` або натисніть `Ctrl+C` у терміналі. Таблиця правил збережеться у файлі `rules.json`, тому при наступному запуску налаштування не втратяться.

